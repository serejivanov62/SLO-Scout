# SLO-Scout Self-Observability SLO Definitions (T143)
#
# Per spec.md FR-025: SLO-Scout must define and measure its own SLOs:
# - 99% ingest freshness < 60s
# - 95% query latency < 2s
# - 95% summarization < 5m
#
# Generated by: SLO-Scout Self-Observability
# Format: Prometheus recording rules for SLO calculation

groups:
  - name: slo_scout_slo_definitions
    interval: 30s
    rules:
      # === Ingest Freshness SLO (99% < 60s) ===

      # Recording rule: Total ingest events per service
      - record: slo_scout:ingest_events:rate5m
        expr: |
          sum by (service, environment, telemetry_type) (
            rate(slo_scout_ingest_events_total{status="success"}[5m])
          )
        labels:
          slo_type: "ingest_freshness"

      # Recording rule: Ingest lag P99
      - record: slo_scout:ingest_lag:p99
        expr: |
          histogram_quantile(0.99,
            sum by (service, environment, telemetry_type, le) (
              rate(slo_scout_ingest_lag_seconds_bucket[5m])
            )
          )
        labels:
          slo_type: "ingest_freshness"
          percentile: "p99"

      # Recording rule: Ingest freshness SLI (% of events with lag < 60s)
      - record: slo_scout:ingest_freshness:sli
        expr: |
          (
            sum by (service, environment) (
              rate(slo_scout_ingest_lag_seconds_bucket{le="60"}[5m])
            )
            /
            sum by (service, environment) (
              rate(slo_scout_ingest_lag_seconds_count[5m])
            )
          ) * 100
        labels:
          slo_type: "ingest_freshness"
          threshold: "60s"

      # Recording rule: Ingest freshness SLO status (1 = meeting SLO, 0 = breach)
      - record: slo_scout:ingest_freshness:slo_status
        expr: |
          slo_scout:ingest_freshness:sli >= 99
        labels:
          slo_type: "ingest_freshness"
          target: "99"

      # Recording rule: Ingest error budget remaining (%)
      - record: slo_scout:ingest_freshness:error_budget_remaining
        expr: |
          (slo_scout:ingest_freshness:sli - 99) / (100 - 99) * 100
        labels:
          slo_type: "ingest_freshness"

      # === Vector Query Latency SLO (95% < 2s) ===

      # Recording rule: Vector query latency P95
      - record: slo_scout:vector_query:p95_latency
        expr: |
          histogram_quantile(0.95,
            sum by (operation, collection, le) (
              rate(slo_scout_vector_query_latency_seconds_bucket[5m])
            )
          )
        labels:
          slo_type: "query_latency"
          percentile: "p95"

      # Recording rule: Vector query latency SLI (% of queries < 2s)
      - record: slo_scout:vector_query:latency_sli
        expr: |
          (
            sum by (operation, collection) (
              rate(slo_scout_vector_query_latency_seconds_bucket{le="2"}[5m])
            )
            /
            sum by (operation, collection) (
              rate(slo_scout_vector_query_latency_seconds_count[5m])
            )
          ) * 100
        labels:
          slo_type: "query_latency"
          threshold: "2s"

      # Recording rule: Vector query latency SLO status
      - record: slo_scout:vector_query:slo_status
        expr: |
          slo_scout:vector_query:latency_sli >= 95
        labels:
          slo_type: "query_latency"
          target: "95"

      # Recording rule: Query latency error budget remaining (%)
      - record: slo_scout:vector_query:error_budget_remaining
        expr: |
          (slo_scout:vector_query:latency_sli - 95) / (100 - 95) * 100
        labels:
          slo_type: "query_latency"

      # === Analysis/Summarization Duration SLO (95% < 5m = 300s) ===

      # Recording rule: Analysis job P95 duration
      - record: slo_scout:analysis:p95_duration
        expr: |
          histogram_quantile(0.95,
            sum by (service, status, le) (
              rate(slo_scout_analysis_job_duration_seconds_bucket{status="success"}[5m])
            )
          )
        labels:
          slo_type: "summarization_duration"
          percentile: "p95"

      # Recording rule: Analysis duration SLI (% of jobs < 300s)
      - record: slo_scout:analysis:duration_sli
        expr: |
          (
            sum by (service) (
              rate(slo_scout_analysis_job_duration_seconds_bucket{le="300",status="success"}[5m])
            )
            /
            sum by (service) (
              rate(slo_scout_analysis_job_duration_seconds_count{status="success"}[5m])
            )
          ) * 100
        labels:
          slo_type: "summarization_duration"
          threshold: "300s"

      # Recording rule: Analysis duration SLO status
      - record: slo_scout:analysis:slo_status
        expr: |
          slo_scout:analysis:duration_sli >= 95
        labels:
          slo_type: "summarization_duration"
          target: "95"

      # Recording rule: Summarization error budget remaining (%)
      - record: slo_scout:analysis:error_budget_remaining
        expr: |
          (slo_scout:analysis:duration_sli - 95) / (100 - 95) * 100
        labels:
          slo_type: "summarization_duration"

      # === Additional Supporting Metrics ===

      # Recording rule: LLM request P95 duration
      - record: slo_scout:llm:p95_duration
        expr: |
          histogram_quantile(0.95,
            sum by (model, operation, le) (
              rate(slo_scout_llm_request_duration_seconds_bucket{status="success"}[5m])
            )
          )
        labels:
          percentile: "p95"

      # Recording rule: LLM success rate
      - record: slo_scout:llm:success_rate
        expr: |
          (
            sum by (model, operation) (
              rate(slo_scout_llm_request_duration_seconds_count{status="success"}[5m])
            )
            /
            sum by (model, operation) (
              rate(slo_scout_llm_request_duration_seconds_count[5m])
            )
          ) * 100
        labels:
          metric_type: "success_rate"

      # Recording rule: Embedding queue saturation
      - record: slo_scout:embedding:queue_saturation
        expr: |
          (
            slo_scout_embedding_queue_length
            /
            scalar(1000)  # Assume 1000 is max capacity
          ) * 100
        labels:
          metric_type: "saturation"

      # Recording rule: HTTP API P95 latency
      - record: slo_scout:api:p95_latency
        expr: |
          histogram_quantile(0.95,
            sum by (method, endpoint, le) (
              rate(slo_scout_http_request_duration_seconds_bucket[5m])
            )
          )
        labels:
          percentile: "p95"

      # Recording rule: HTTP API success rate
      - record: slo_scout:api:success_rate
        expr: |
          (
            sum by (method, endpoint) (
              rate(slo_scout_http_requests_total{status=~"2.."}[5m])
            )
            /
            sum by (method, endpoint) (
              rate(slo_scout_http_requests_total[5m])
            )
          ) * 100
        labels:
          metric_type: "success_rate"

      # Recording rule: Kafka consumer lag health
      - record: slo_scout:kafka:consumer_lag_seconds
        expr: |
          slo_scout_kafka_consumer_lag
          /
          (rate(slo_scout_kafka_messages_consumed_total{status="success"}[5m]) + 0.001)
        labels:
          metric_type: "lag_estimate"

      # Recording rule: Database query P95 latency
      - record: slo_scout:db:p95_latency
        expr: |
          histogram_quantile(0.95,
            sum by (database, operation, le) (
              rate(slo_scout_db_query_duration_seconds_bucket[5m])
            )
          )
        labels:
          percentile: "p95"

      # === Multi-window SLO tracking (for error budget burn rate) ===

      # 1-hour window
      - record: slo_scout:ingest_freshness:sli_1h
        expr: |
          (
            sum by (service, environment) (
              rate(slo_scout_ingest_lag_seconds_bucket{le="60"}[1h])
            )
            /
            sum by (service, environment) (
              rate(slo_scout_ingest_lag_seconds_count[1h])
            )
          ) * 100
        labels:
          window: "1h"

      # 6-hour window
      - record: slo_scout:ingest_freshness:sli_6h
        expr: |
          (
            sum by (service, environment) (
              rate(slo_scout_ingest_lag_seconds_bucket{le="60"}[6h])
            )
            /
            sum by (service, environment) (
              rate(slo_scout_ingest_lag_seconds_count[6h])
            )
          ) * 100
        labels:
          window: "6h"

      # 24-hour window
      - record: slo_scout:ingest_freshness:sli_24h
        expr: |
          (
            sum by (service, environment) (
              rate(slo_scout_ingest_lag_seconds_bucket{le="60"}[24h])
            )
            /
            sum by (service, environment) (
              rate(slo_scout_ingest_lag_seconds_count[24h])
            )
          ) * 100
        labels:
          window: "24h"

      # 30-day window
      - record: slo_scout:ingest_freshness:sli_30d
        expr: |
          (
            sum by (service, environment) (
              rate(slo_scout_ingest_lag_seconds_bucket{le="60"}[30d])
            )
            /
            sum by (service, environment) (
              rate(slo_scout_ingest_lag_seconds_count[30d])
            )
          ) * 100
        labels:
          window: "30d"
